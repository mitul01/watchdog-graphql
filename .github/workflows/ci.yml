name: CI (Build & Publish)

on:
  push:
    branches:
      - 'main'

env:
  REGISTRY: ghcr.io
  # github.repository as <account>/<repo>
  IMAGE_NAME: ${{ github.repository }}
  # buildpack builder
  BUILDER: paketobuildpacks/builder-jammy-tiny
  
jobs:
  maven-build-test:
    uses: ./.github/workflows/maven.yml

  build-publish:
    needs: maven-build-test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Pack CLI
      uses: buildpacks/github-actions/setup-pack@v5.0.0
  
    - name: Extract Git Metadata
      shell: bash
      run: |
        echo "SHA_TAG=$(git rev-parse --short "$GITHUB_SHA")" >> "$GITHUB_ENV"
        echo "BRANCH=$(echo ${GITHUB_REF#refs/heads/})" >> "$GITHUB_ENV"

    - name: Build Image using Pack CLI
      run: |
        #!/usr/bin/env bash
        pack build ${{env.REGISTRY}}/${{env.IMAGE_NAME}}:${{env.SHA_TAG}} --path . --builder ${{env.BUILDER}}

    - name: Log into registry ${{ env.REGISTRY }}
      uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Publish Image
      run: |
        docker tag ${{env.REGISTRY}}/${{env.IMAGE_NAME}}:${{env.SHA_TAG}} ${{env.REGISTRY}}/${{env.IMAGE_NAME}}:latest
        docker push ${{env.REGISTRY}}/${{env.IMAGE_NAME}}:${{env.SHA_TAG}}
    
    - name: Repository Dispatch to watchdog-config
      uses: peter-evans/repository-dispatch@v3
      with:
        token: ${{ secrets.WATCHDOG_CONFIG_REPO_TOKEN }}
        repository: ${{ github.actor }}/watchdog-config
        event-type: publish-pkg
        client-payload: '{"ref": "${{ github.ref }}", "sha": "${{ env.SHA_TAG }}", "app_name": "watchdog-graphql", "image": "${{env.REGISTRY}}/${{env.IMAGE_NAME}}:${{env.SHA_TAG}}", "version": "0.0.1" }'
